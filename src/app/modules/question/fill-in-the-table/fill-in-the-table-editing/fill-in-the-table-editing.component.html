@if (question.tableContent) {
  <div class="d-flex flex-column mt-2">
    <div class="description">
      <angular-editor
        [name]="question.id"
        [config]="config"
        [(ngModel)]="question.content"
        (ngModelChange)="onPaste($event)"
      ></angular-editor>
    </div>
    <div class="d-flex flex-column mt-3">
      <table>
        <th [colSpan]="headerColSpan" class="align-middle">
          <input [(ngModel)]="question.name" class="my-2" />
        </th>
        <th colspan="1" class="text-start">
          <mat-icon color="primary" (click)="addNewColumn()">add</mat-icon>
        </th>
        @for (row of question.tableContent | keyvalue; track $index; ) {
          @let rowIndex = $index;
          <tr>
            @for (column of row.value | keyvalue; track $index; ) {
              @let editingCell = this.mapEditingByCell[row.key + '' + column.key];
              <td class="m-1">
                <div class="d-flex flex-wrap align-items-center m-2"
                     [ngClass]="{'justify-content-center': row.key === 'tr0' || column.key === 'td0'}">
                  <div class="d-flex flex-column">
                    @for (line of column.value; track $index; let lineIndex = $index) {
                      <div class="d-flex flex-row flex-wrap">
                        @for (content of line; track $index; let contentIndex = $index) {
                          <div class="d-flex flex-row">
                            @if ((content | isInput)) {
                              @let choiceId = (content | extractId);
                              @let choice = mapChoiceById[choiceId];
                              @if (choice) {
                                <div class="d-flex mx-1">
                                  <input class="mt-1" [(ngModel)]="mapChoiceById[choiceId].correctAnswer"
                                         (click)="editText(row.key, column.key, lineIndex, contentIndex)" />
                                  @if (editingCell[lineIndex][contentIndex]) {
                                    <div class="d-flex align-items-center">
                                      <mat-icon color="primary"
                                                (click)="saveColumnInput()">
                                        check
                                      </mat-icon>
                                      <mat-icon color="warn"
                                                (click)="deleteColumnInput(row.key, column.key, lineIndex, contentIndex)">
                                        delete
                                      </mat-icon>
                                      <button class="d-flex align-items-center ms-1"
                                              (click)="addColumnText(row.key, column.key, lineIndex, contentIndex)">
                                        <mat-icon color="primary">add</mat-icon>
                                        Text
                                      </button>
                                    </div>
                                  }
                                </div>
                              }
                            } @else {
                              @if (editingCell && editingCell[lineIndex] && editingCell[lineIndex][contentIndex]) {
                                <div class="d-flex align-items-center">
                                  <input class="mt-1"
                                         [(ngModel)]="question.tableContent[row.key][column.key][lineIndex][contentIndex]" />
                                  <mat-icon color="primary"
                                            (click)="saveColumnText(row.key, column.key, lineIndex, contentIndex)">
                                    check
                                  </mat-icon>
                                  @if (contentIndex !== 0) {
                                    <mat-icon color="warn"
                                              (click)="deleteColumnText(row.key, column.key, lineIndex, contentIndex)">
                                      delete
                                    </mat-icon>
                                  }
                                  @if (row.key !== 'tr0' && column.key !== 'td0') {
                                    <button class="d-flex align-items-center ms-1"
                                            (click)="addColumnInput(row.key, column.key, lineIndex, contentIndex)">
                                      <mat-icon color="primary">add</mat-icon>
                                      Input
                                    </button>
                                  }
                                </div>
                              } @else {
                                <div class="d-flex flex-row">
                                  @if (row.key === 'tr0' || column.key === 'td0') {
                                    <b>
                                      <p class="my-2"
                                         (click)="editText(row.key, column.key, lineIndex, contentIndex)">{{ content === '' ? '...' : content }}</p>
                                    </b>
                                  } @else {
                                    <p class="my-2"
                                       (click)="editText(row.key, column.key, lineIndex, contentIndex)">{{ content === '' ? '...' : content }}</p>
                                  }
                                </div>
                              }
                            }
                          </div>
                        }
                      </div>
                      @if (row.key !== 'tr0' && column.key !== 'td0') {
                        <div class="d-flex mt-2">
                          <button mat-button class="d-flex align-items-center me-1"
                                  (click)="addNewLineInColumn(row.key, column.key, lineIndex)">
                            <mat-icon color="primary">add</mat-icon>
                            Line
                          </button>
                          <button mat-button class="d-flex align-items-center me-1"
                                  (click)="deleteLineInColumn(row.key, column.key, lineIndex)">
                            <mat-icon color="warn">delete</mat-icon>
                            Line
                          </button>
                        </div>
                      }
                    }
                  </div>
                </div>
              </td>
            }
            @if (row.key !== 'tr0') {
              <td>
                <mat-icon color="warn" (click)="deleteRow(rowIndex)">
                  delete
                </mat-icon>
              </td>
            }
          </tr>
        }
        <tr>
          @for (column of question.tableContent['tr0'] | keyvalue; track $index; ) {
            @if ($index !== 0) {
              <td>
                <mat-icon color="warn" (click)="deleteColumn($index)">
                  delete
                </mat-icon>
              </td>
            } @else {
              <td class="text-start">
                <mat-icon color="primary" (click)="addNewRow()">add</mat-icon>
              </td>
            }
          }
        </tr>
      </table>
    </div>
  </div>
}
